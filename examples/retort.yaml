version: 1
schema:
  types:
    dcim.site:
      key:
        site:
          type: slug
      fields:
        name:
          type: string
        slug:
          type: slug
    dcim.device:
      key:
        site:
          type: slug
        device:
          type: slug
      fields:
        name:
          type: string
        role:
          type: string
        device_type:
          type: string
        site:
          type: ref
          target: dcim.site
        model.fabric:
          type: string
        model.role_hint:
          type: string
        model.tags:
          type: list
          item:
            type: string
    dcim.interface:
      key:
        device:
          type: slug
        interface:
          type: slug
      fields:
        name:
          type: string
        device:
          type: ref
          target: dcim.device
    ipam.prefix:
      key:
        prefix:
          type: prefix
      fields:
        prefix:
          type: prefix
        site:
          type: ref
          target: dcim.site
    ipam.ip_address:
      key:
        ip:
          type: ip_address
      fields:
        address:
          type: ip_address
        assigned_interface:
          type: ref
          target: dcim.interface
    services.evpn:
      key:
        evpn:
          type: slug
      fields:
        name:
          type: string
        asn:
          type: int
        vtep_pool:
          type: string
        route_targets:
          type: map
          value:
            type: string
rules:
  - name: sites
    select: /sites/*
    emit:
      type: dcim.site
      key:
        site: "${slug}"
      uid:
        v5:
          type: "dcim.site"
          stable: "site=${slug}"
      vars:
        slug: { from: .slug, required: true }
        name: { from: .name, required: true }
      attrs:
        name: ${name}
        slug: ${slug}

  - name: devices
    select: /sites/*/devices/*
    emit:
      type: dcim.device
      key:
        site: "${site_slug}"
        device: "${name}"
      uid:
        v5:
          type: "dcim.device"
          stable: "device=${name}"
      vars:
        name: { from: .name, required: true }
        role: { from: .role, required: true }
        device_type: { from: .device_type, required: true }
        site_slug: { from: ^.slug, required: true }
        model_fabric: { from: .model/fabric, required: true }
        model_role_hint: { from: .model/role_hint, required: true }
        model_tags: { from: .model/tags, required: true }
      attrs:
        name: ${name}
        role: ${role}
        device_type: ${device_type}
        site:
          uid:
            type: "dcim.site"
            stable: "site=${site_slug}"
        model.fabric: ${model_fabric}
        model.role_hint: ${model_role_hint}
        model.tags: ${model_tags}

  - name: interfaces
    select: /sites/*/devices/*/interfaces/*
    emit:
      type: dcim.interface
      key:
        device: "${device_name}"
        interface: "${name}"
      uid:
        v5:
          type: "dcim.interface"
          stable: "if=${device_name}/${name}"
      vars:
        name: { from: .name, required: true }
        device_name: { from: ^.name, required: true }
      attrs:
        name: ${name}
        device:
          uid:
            type: "dcim.device"
            stable: "device=${device_name}"

  - name: prefixes
    select: /prefixes/*
    emit:
      type: ipam.prefix
      key:
        prefix: "${prefix}"
      uid:
        v5:
          type: "ipam.prefix"
          stable: "prefix=${prefix}"
      vars:
        prefix: { from: .prefix, required: true }
        site_slug: { from: .site, required: false }
      attrs:
        prefix: ${prefix}
        site:
          uid?:
            type: "dcim.site"
            stable: "site=${site_slug}"

  - name: ips
    select: /prefixes/*/ips/*
    emit:
      type: ipam.ip_address
      key:
        ip: "${address}"
      uid:
        v5:
          type: "ipam.ip_address"
          stable: "ip=${address}"
      vars:
        address: { from: .address, required: true }
        device: { from: .device, required: true }
        interface: { from: .interface, required: true }
      attrs:
        address: ${address}
        assigned_interface:
          uid:
            type: "dcim.interface"
            stable: "if=${device}/${interface}"

  - name: evpn
    select: /services/evpn
    emit:
      type: services.evpn
      key:
        evpn: "${name}"
      uid:
        v5:
          type: "services.evpn"
          stable: "evpn=${name}"
      vars:
        name: { from: .name, required: true }
        asn: { from: .asn, required: true }
        vtep_pool: { from: .vtep_pool, required: true }
        rt_import: { from: .route_targets/import, required: true }
        rt_export: { from: .route_targets/export, required: true }
      attrs:
        name: ${name}
        asn: ${asn}
        vtep_pool: ${vtep_pool}
        route_targets:
          import: ${rt_import}
          export: ${rt_export}
