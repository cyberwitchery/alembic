# Example: multi-emit retort rules
#
# This demonstrates emitting multiple objects from a single yaml element,
# such as creating a site, vrf, and route targets from one fabric definition.

version: 1
schema:
  types:
    dcim.site:
      key:
        site:
          type: slug
      fields:
        name:
          type: string
        slug:
          type: slug
    ipam.vrf:
      key:
        vrf:
          type: slug
      fields:
        name:
          type: string
        rd:
          type: string
        route_targets:
          type: map
          value:
            type: string
        site:
          type: ref
          target: dcim.site
rules:
  # Single fabric definition emits site + vrf + route targets
  - name: fabric
    select: /fabrics/*
    vars:
      name: { from: .name, required: true }
      site_slug: { from: .site, required: true }
      vrf_name: { from: .vrf, required: true }
      rt_import: { from: .route_targets/import, required: true }
      rt_export: { from: .route_targets/export, required: true }
    uids:
      site:
        v5:
          type: "dcim.site"
          stable: "site=${site_slug}"
      vrf:
        v5:
          type: "ipam.vrf"
          stable: "vrf=${vrf_name}"
    emit:
      - type: dcim.site
        key:
          site: "${site_slug}"
        uid: ${uids.site}
        attrs:
          name: ${name}
          slug: ${site_slug}

      - type: ipam.vrf
        key:
          vrf: "${vrf_name}"
        uid: ${uids.vrf}
        attrs:
          name: ${vrf_name}
          rd: ${rt_export}
          route_targets:
            import: ${rt_import}
            export: ${rt_export}
          site: ${uids.site}
