# alembic

distills data between dcim/ipam systems, co-evolved with ai

alembic is a data-model-first converger + loader for dcim/ipam systems. it defines a canonical, vendor-neutral ir (intermediate representation) and an engine that validates, plans, and applies changes to a backend. the first backend adapter targets netbox via the `netbox` rust crate.

## concepts

- **ir objects**: typed objects with stable `uid` (uuid), a `type`, a human `key`, and `attrs`.
- **relationships**: references are always by `uid`, never backend ids.
- **plan**: a deterministic list of operations (create/update/delete) generated by diffing desired ir against observed backend state.
- **state store**: `.alembic/state.json` maps `uid` to backend ids per type to keep renames stable.

## quickstart

1) create a brew file (yaml) describing your desired state. see `examples/brew.yaml`.

2) validate:

```bash
cargo run -p alembic-cli -- validate -f examples/brew.yaml
```

3) plan (writes a json plan file):

```bash
NETBOX_URL=https://netbox.example.com NETBOX_TOKEN=... \
  cargo run -p alembic-cli -- plan -f examples/brew.yaml -o plan.json
```

4) apply:

```bash
NETBOX_URL=https://netbox.example.com NETBOX_TOKEN=... \
  cargo run -p alembic-cli -- apply -p plan.json --allow-delete
```

5) raw + retort + projection:

```bash
cargo run -p alembic-cli -- distill -f examples/raw.yaml --retort examples/retort.yaml -o ir.json
cargo run -p alembic-cli -- plan -f examples/raw.yaml --retort examples/retort.yaml \
  --projection examples/projection-netbox.yaml -o plan.json
```

## netbox adapter coverage

types supported end-to-end by the netbox adapter:

- `dcim.site`
- `dcim.device`
- `dcim.interface`
- `ipam.prefix`
- `ipam.ip_address`

relationships (validated when declared in the schema):

- `dcim.device.attrs.site` -> `dcim.site.uid`
- `dcim.interface.attrs.device` -> `dcim.device.uid`
- `ipam.ip_address.attrs.assigned_interface` -> `dcim.interface.uid`
- `ipam.prefix.attrs.site` -> `dcim.site.uid` (optional)

## workspace layout

- `crates/alembic-core`: ir types, serde, validation primitives
- `crates/alembic-engine`: loader, graph validation, planning, state store
- `crates/alembic-adapter-netbox`: netbox adapter
- `crates/alembic-cli`: cli binary

## notes

- input files never contain backend ids.
- plans are deterministic and stable-sorted.
- deletes are gated behind `--allow-delete`.

## documentation

- `docs/index.md`
- `docs/ir.md`
- `docs/brew.md`
- `docs/engine.md`
- `docs/plan.md`
- `docs/state.md`
- `docs/cli.md`
- `docs/netbox.md`
- `docs/development.md`
